<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoundCloud Web App</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
    .playlist-card { display:flex; flex-direction:column; align-items:center; margin:15px; background:white; border-radius:10px; padding:15px; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:90%; max-width:400px; cursor:pointer; transition: transform 0.2s; }
    .playlist-card:hover { transform: scale(1.03); }
    .playlist-card img { width:100%; border-radius:10px; margin-bottom:10px; }
    .playlist-card h3 { margin:5px 0; }
    .playlist-card p { font-size:14px; color:#555; }
    #playerContainer { margin:20px auto; width:90%; max-width:700px; }
  </style>
</head>
<body>

<h2 style="text-align:center; padding:10px;">SoundCloud Playlists</h2>
<div id="playlistContainer"></div>
<div id="playerContainer"></div>

<script src="https://w.soundcloud.com/player/api.js"></script>
<script>
  const playlistContainer = document.getElementById("playlistContainer");
  const playerContainer = document.getElementById("playerContainer");

  // Detect Android bridge for rewarded ads
  function hasAndroidBridge(){
    return (typeof Android !== 'undefined' && Android !== null);
  }

  let songCounter = 0; // count songs for rewarded ads
  let widget; // SoundCloud widget object

  // Load playlist data from data.json
  fetch('data.json')
    .then(response => response.json())
    .then(playlists => {
      // Display playlists
      playlists.forEach((pl, idx) => {
        const card = document.createElement("div");
        card.className = "playlist-card";
        card.innerHTML = `
          <img src="${pl.image_url}" alt="${pl.title}">
          <h3>${pl.title}</h3>
          <p>${pl.description}</p>
        `;
        card.addEventListener("click", () => {
          loadPlaylist(pl.playlist_link);
        });
        playlistContainer.appendChild(card);
      });
    })
    .catch(err => {
      console.error("Error loading data.json:", err);
      playlistContainer.innerHTML = "<p style='color:red;'>Failed to load playlists.</p>";
    });

  // Load and play selected playlist
  function loadPlaylist(link) {
    playerContainer.innerHTML = `
      <iframe id="scPlayer" width="100%" height="450" scrolling="no" frameborder="no"
        allow="autoplay"
        src="https://w.soundcloud.com/player/?url=${encodeURIComponent(link)}">
      </iframe>
    `;
    const iframe = document.getElementById("scPlayer");
    widget = SC.Widget(iframe);

    // When widget ready, start random play
    widget.bind(SC.Widget.Events.READY, function() {
      playRandomTrack();
    });

    // Detect song finish for autoplay + rewarded ads
    widget.bind(SC.Widget.Events.FINISH, function() {
      songCounter++;
      if(songCounter % 5 === 0 && hasAndroidBridge()){
        Android.requestRewardedAd(); // call native rewarded ad
      }
      playRandomTrack();
    });
  }

  // Play random track in playlist
  function playRandomTrack() {
    widget.getCurrentSoundIndex(function(currentIndex){
      widget.getSounds(function(sounds){
        const total = sounds.length;
        if(total > 1){
          let nextIndex;
          do{
            nextIndex = Math.floor(Math.random()*total);
          } while(nextIndex === currentIndex);
          widget.skip(nextIndex);
        }
        widget.play();
      });
    });
  }

  // Preload rewarded ad on app load (optional)
  if(hasAndroidBridge()){
    Android.preloadRewardedAd();
  }

  // Optional callback when ad completed
  window.onAdCompleted = function(targetUrl){
    console.log("Rewarded ad finished for playlist: ", targetUrl);
  }

</script>
</body>
</html>
